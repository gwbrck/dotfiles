{{- if (eq .chezmoi.os "linux") -}}
#!/bin/fish

sudo mkdir -p /etc/interception/dual-function-keys/
sudo mkdir -p /opt/interception/
echo "
TIMING:
  TAP_MILLISEC: 200
  DOUBLE_TAP_MILLISEC: 0

MAPPINGS:
  - KEY: KEY_CAPSLOCK
    TAP: KEY_ESC
    HOLD: [ KEY_LEFTCTRL, KEY_LEFTMETA, KEY_LEFTALT, KEY_LEFTSHIFT, ]
  - KEY: KEY_BACKSLASH
    TAP: KEY_BACKSLASH
    HOLD: KEY_LEFTCTRL
" | sudo tee /etc/interception/dual-function-keys/gwbrck-map.yaml

echo "
- JOB: intercept -g \$DEVNODE | dual-function-keys -c /etc/interception/dual-function-keys/gwbrck-map.yaml | /opt/interception/interception-pipe1 | uinput -d \$DEVNODE
  DEVICE:
    EVENTS:
      EV_KEY: [KEY_CAPSLOCK, KEY_BACKSLASH]
" | sudo tee /etc/interception/udevmon.yaml

sudo cp -f {{ joinPath .chezmoi.sourceDir "bin/interception-pipe1" }} /opt/interception/interception-pipe1

sudo systemctl enable udevmon.service
sudo systemctl restart udevmon.service
{{ end -}}
